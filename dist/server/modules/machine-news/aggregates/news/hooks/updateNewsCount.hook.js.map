{"version":3,"sources":["../../../../../../../src/server/modules/machine-news/aggregates/news/hooks/updateNewsCount.hook.ts"],"names":["updateNewsCount","context","newsId","id","newsRepository","findById","newsInfo","oldNews","forEach","item","repository","brandRepository","modelRepository","provinceRepository","_id","increaseNewsCount","decreaseNewsCount","categoryId","categoryRepository"],"mappings":";;;;;;;;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;;;AAEO,IAAMA,eAAe;AAAA;AAAA;AAAA;AAAA;AAAA,4BAAG,iBAAOC,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AACvBC,YAAAA,MADuB,GACdD,OAAO,CAACE,EADM;AAAA;AAAA,mBAENC,qBAAeC,QAAf,CAAwBH,MAAxB,CAFM;;AAAA;AAEvBI,YAAAA,QAFuB;AAGvBC,YAAAA,OAHuB,GAGZN,OAAD,CAAiBM,OAHJ;AAK7B,aAAC,OAAD,EAAU,OAAV,EAAmB,UAAnB,EAA+BC,OAA/B,CAAuC,UAACC,IAAD,EAAU;AAC/C,kBAAIC,UAAJ;;AACA,sBAAQD,IAAR;AACE,qBAAK,OAAL;AACEC,kBAAAA,UAAU,GAAGC,uBAAb;AACA;;AACF,qBAAK,OAAL;AACED,kBAAAA,UAAU,GAAGE,uBAAb;AACA;;AACF,qBAAK,UAAL;AACEF,kBAAAA,UAAU,GAAGG,6BAAb;AACA;AATJ;;AAYA,kBAAIP,QAAQ,IAAIA,QAAQ,CAACG,IAAD,CAApB,IAA+BH,QAAQ,CAACG,IAAD,CAAT,CAAwBK,GAA1D,EAA+D;AAC7D,oBAAI,CAACP,OAAO,CAACE,IAAD,CAAR,IAAkB,CAACF,OAAO,CAACE,IAAD,CAAP,CAAcK,GAArC,EAA0C;AACxCJ,kBAAAA,UAAU,CAACK,iBAAX,CAA8BT,QAAQ,CAACG,IAAD,CAAT,CAAwBK,GAArD;AACD,iBAFD,MAEO,IAAIP,OAAO,CAACE,IAAD,CAAP,CAAcK,GAAd,IAAqBP,OAAO,CAACE,IAAD,CAAP,CAAcK,GAAd,KAAuBR,QAAQ,CAACG,IAAD,CAAT,CAAwBK,GAAvE,EAA4E;AACjFJ,kBAAAA,UAAU,CAACK,iBAAX,CAA8BT,QAAQ,CAACG,IAAD,CAAT,CAAwBK,GAArD;AACAJ,kBAAAA,UAAU,CAACM,iBAAX,CAA6BT,OAAO,CAACE,IAAD,CAAP,CAAcK,GAA3C;AACD;AACF,eAPD,MAOO,IAAIR,QAAQ,IAAIA,QAAQ,CAACG,IAAD,CAApB,IAA8B,CAAEH,QAAQ,CAACG,IAAD,CAAT,CAAwBK,GAA3D,EAAgE;AACrE,oBAAIP,OAAO,CAACE,IAAD,CAAP,IAAiBF,OAAO,CAACE,IAAD,CAAP,CAAcK,GAAnC,EAAwC;AACtCJ,kBAAAA,UAAU,CAACM,iBAAX,CAA6BT,OAAO,CAACE,IAAD,CAAP,CAAcK,GAA3C;AACD;AACF;AACF,aA1BD;;AA4BA,gBAAIR,QAAQ,IAAIA,QAAQ,CAACW,UAArB,IAAoCX,QAAQ,CAACW,UAAV,CAA6BH,GAApE,EAAyE;AACvE,kBAAIP,OAAO,CAACU,UAAR,CAAmBH,GAAnB,IAA0BP,OAAO,CAACU,UAAR,CAAmBH,GAAnB,KAA4BR,QAAQ,CAACW,UAAV,CAA6BH,GAAtF,EAA2F;AACzFI,+CAAmBH,iBAAnB,CAAsCT,QAAQ,CAACW,UAAV,CAA6BH,GAAlE;;AACAI,+CAAmBF,iBAAnB,CAAqCT,OAAO,CAACU,UAAR,CAAmBH,GAAxD;AACD;AACF;;AAtC4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAfd,eAAe;AAAA;AAAA;AAAA,GAArB","sourcesContent":["import { HookContext } from '@feathersjs/feathers';\nimport { newsRepository } from '../news.repository';\nimport { brandRepository } from '../../brands/brands.repository';\nimport { modelRepository } from '../../models/models.repository';\nimport { provinceRepository } from '../../provinces/provinces.repository';\nimport { categoryRepository } from '../../categories/categories.repository';\n\nexport const updateNewsCount = async (context: HookContext) => {\n  const newsId = context.id;\n  const newsInfo = await newsRepository.findById(newsId as any);\n  const oldNews = (context as any).oldNews;\n\n  ['brand', 'model', 'location'].forEach((item) => {\n    let repository: any;\n    switch (item) {\n      case 'brand':\n        repository = brandRepository;\n        break;\n      case 'model':\n        repository = modelRepository;\n        break;\n      case 'location':\n        repository = provinceRepository;\n        break;\n    }\n\n    if (newsInfo && newsInfo[item] && (newsInfo[item] as any)._id) {\n      if (!oldNews[item] || !oldNews[item]._id) {\n        repository.increaseNewsCount((newsInfo[item] as any)._id);\n      } else if (oldNews[item]._id && oldNews[item]._id !== (newsInfo[item] as any)._id) {\n        repository.increaseNewsCount((newsInfo[item] as any)._id);\n        repository.decreaseNewsCount(oldNews[item]._id);\n      }\n    } else if (newsInfo && newsInfo[item] && !(newsInfo[item] as any)._id) {\n      if (oldNews[item] && oldNews[item]._id) {\n        repository.decreaseNewsCount(oldNews[item]._id);\n      }\n    }\n  });\n\n  if (newsInfo && newsInfo.categoryId && (newsInfo.categoryId as any)._id) {\n    if (oldNews.categoryId._id && oldNews.categoryId._id !== (newsInfo.categoryId as any)._id) {\n      categoryRepository.increaseNewsCount((newsInfo.categoryId as any)._id);\n      categoryRepository.decreaseNewsCount(oldNews.categoryId._id);\n    }\n  }\n};\n"],"file":"updateNewsCount.hook.js"}