{"version":3,"sources":["../../../../../../src/server/modules/machine-news/aggregates/shop/shop.repository.ts"],"names":["ShopSchema","mongoose","Schema","owner","type","String","ref","domain","name","address","geocode","lng","Number","lat","description","phone","email","introImages","logoImage","followBy","default","isActive","Boolean","expiryDate","counterFollow","ShopModel","model","shopRepository","getAll","find","populate","exec","count","_query","NotImplementedError","query","filters","search","push","$text","$search","undefined","sortBy","first","before","after","findOne","findById","id","create","payload","newShop","_id","save","update","findByIdAndUpdate","$set","follow","findOneAndUpdate","$push","followerId","new","unfollow","$pull","del","ensureIndexes","increaseFollowCount","$inc","decreaseFollowCount"],"mappings":"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","sourcesContent":["import mongoose from 'mongoose';\nimport { addDeletableSchema, addAuditableSchema, execCursorPaging, NotImplementedError } from '@app/core';\nimport { ShopRepository } from './interfaces/ShopRepository';\n\nconst ShopSchema = new mongoose.Schema(addAuditableSchema(addDeletableSchema({\n  owner: {\n    type: String,\n    ref: 'User',\n  },\n  domain: String,\n  name: String,\n  address: String,\n  geocode: {\n    lng: Number,\n    lat: Number,\n  },\n  description: String,\n  phone: String,\n  email: String,\n  introImages: [String],\n  logoImage: String,\n  followBy: {\n    type: [{ type: String, ref: 'User' }],\n    default: [],\n  },\n  isActive: {\n    type: Boolean,\n    default: true,\n  },\n  expiryDate: Number,\n  counterFollow: {\n    type: Number,\n    default: 0,\n  },\n})));\nexport const ShopModel = mongoose.model('Shop', ShopSchema);\n\nexport const shopRepository: ShopRepository = {\n  getAll: async () => {\n    return await ShopModel.find().populate('owner').exec() as any;\n  },\n  count: async (_query) => {\n    throw new NotImplementedError();\n  },\n  find: async (query) => {\n    const filters: any[] = [];\n    if (query.search) {\n      filters.push({ $text: { $search: `\"${query.search}\"` } });\n    }\n    if (query.isActive !== undefined) {\n      filters.push({ isActive: query.isActive });\n    }\n\n    return await execCursorPaging(\n      ShopModel,\n      filters,\n      query.sortBy,\n      Number(query.first),\n      ['owner'],\n      query.before,\n      query.after,\n    );\n  },\n  findOne: async (query: { domain?: string; owner?: string }) => {\n    if (query.domain) {\n      return await ShopModel.findOne({ domain: query.domain }).exec() as any;\n    }\n    if (query.owner) {\n      return await ShopModel.findOne({ owner: query.owner }).exec() as any;\n    }\n  },\n  findById: async (id) => {\n    return await ShopModel.findById(id)\n      .populate('owner')\n      .exec() as any;\n  },\n  create: async (payload) => {\n    const newShop = new ShopModel({\n      ...payload,\n      _id: payload.id,\n    });\n    await newShop.save();\n    return newShop.id;\n  },\n  update: async (payload) => {\n    await ShopModel.findByIdAndUpdate(payload.id, { $set: payload }).exec();\n  },\n  follow: async (payload) => {\n    await ShopModel.findOneAndUpdate({ _id: payload.id }, { $push: { followBy: payload.followerId } }, { new: true }).exec();\n  },\n  unfollow: async (payload) => {\n    await ShopModel.findOneAndUpdate({ _id: payload.id }, { $pull: { followBy: payload.followerId } }, { new: true }).exec();\n  },\n  del: async (_id): Promise<void> => {\n    throw new NotImplementedError();\n  },\n  ensureIndexes: async () => {\n    await ShopModel.ensureIndexes({ name: 'text' });\n  },\n  increaseFollowCount: async (id: string) => {\n    await ShopModel.findByIdAndUpdate(id, {$inc: {counterFollow: 1}}).exec();\n  },\n  decreaseFollowCount: async (id: string) => {\n    await ShopModel.findByIdAndUpdate(id, {$inc: {counterFollow: -1}}).exec();\n  },\n};\n"],"file":"shop.repository.js"}